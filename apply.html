<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Apply</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="index.html">NextHire</a>
  </div>
</nav>
<div class="container my-4">
  <h3>Apply</h3>
  <div id="jobDetails" class="mb-4"></div>
  <form id="form" enctype="multipart/form-data" class="mt-3">
    <div class="mb-3">
      <label for="jobTitle">Job</label>
      <input id="jobTitle" title="Job title" placeholder="Enter job title" class="form-control">
    </div>
    <div class="mb-3">
      <label for="jobCompany">Company</label>
      <select id="jobCompany" title="Company" class="form-select">
        <option value="">Select company</option>
        <option>Acme Corp</option>
        <option>BetaWorks</option>
        <option>ClearTech</option>
        <option>Delta Systems</option>
        <option>Evergreen LLC</option>
        <option>Falcon Industries</option>
      </select>
    </div>
    <div class="row">
      <div class="mb-3 col-md-6">
        <label for="jobLocation">Location</label>
        <input id="jobLocation" title="Location" placeholder="Enter location (city or Remote)" class="form-control">
      </div>
      <div class="mb-3 col-md-6">
        <label for="jobType">Type</label>
        <select id="jobType" title="Job type" class="form-select">
          <option value="">Select type</option>
          <option value="Full Time">Full Time</option>
          <option value="Part Time">Part Time</option>
          <option value="Contract">Contract</option>
          <option value="Internship">Internship</option>
          <option value="Remote">Remote</option>
          <option value="Hybrid">Hybrid</option>
          <option value="Other">Other (specify)</option>
        </select>
        <input id="jobTypeOther" title="Other job type" placeholder="Specify job type" class="form-control mt-2 d-none" />
      </div>
    </div>
    <div class="row">
      <div class="mb-3 col-md-6">
        <label for="salaryMin">Salary (min)</label>
        <input id="salaryMin" name="salaryMin" title="Minimum salary" placeholder="e.g. 50000" class="form-control" inputmode="numeric">
      </div>
      <div class="mb-3 col-md-6">
        <label for="salaryMax">Salary (max)</label>
        <input id="salaryMax" name="salaryMax" title="Maximum salary" placeholder="e.g. 70000" class="form-control" inputmode="numeric">
      </div>
    </div>
    <div class="mb-3">
      <label for="fullName">Full name</label>
      <input id="fullName" title="Full name" placeholder="Your full name" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="email">Email</label>
      <input id="email" title="Email" placeholder="you@example.com" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="resume">Resume (PDF)</label>
      <input id="resume" type="file" accept=".pdf" title="Upload PDF resume" class="form-control" required>
    </div>
  <button type="submit" class="btn btn-success">Submit</button>
  </form>
  <div id="msg" class="mt-3"></div>
</div>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const params = new URLSearchParams(location.search);
  const jobId = params.get('job');
  if (!jobId) { alert('Job missing'); location.href='index.html'; return; }

  function renderJob(job){
    if(!job) return;

    const details = document.getElementById('jobDetails');

  // prepare displays for type and salary
  // We'll compute a deterministic (per jobId) auto-generated type when needed
  const rawType = (job.type || job.jobType || job.employmentType || job.job_type || '').toString().trim();
  const standardTypes = ['Full Time','Part Time','Contract','Internship','Remote','Hybrid'];
  // stable hash function to map jobId to integer
  function stableHash(s){ let h=0; for(let i=0;i<s.length;i++){ h = ((h<<5)-h) + s.charCodeAt(i); h |= 0; } return Math.abs(h); }
  let autoGeneratedType = false;
  // determine a deterministic preferred type for display
  let preferredType = rawType;
  if ((!preferredType || preferredType.toLowerCase() === 'full time')) {
    // pick deterministic alternative to avoid 'Full Time' for most auto-fills
    const candidates = standardTypes.filter(t => t.toLowerCase() !== 'full time');
    const idx = stableHash((jobId || '') + '-type') % candidates.length;
    preferredType = candidates[idx];
    autoGeneratedType = true;
  }
  let typeDisplay = preferredType;
    // determine salary min/max for display
    let dispMin = job.salaryMin || job.minSalary || (job.salary && job.salary.min) || job.min || null;
    let dispMax = job.salaryMax || job.maxSalary || (job.salary && job.salary.max) || job.max || null;
  if ((!dispMin && !dispMax) && job.salary) {
      const sal = job.salary;
      if (typeof sal === 'number') dispMin = sal;
      else if (typeof sal === 'string') {
        const cleaned = sal.replace(/\s+/g,'');
        const rangeMatch = cleaned.match(/(\d{1,3}(?:,\d{3})*(?:\.\d+)?)[-–—to]{1,3}(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/i);
        if (rangeMatch) {
          dispMin = rangeMatch[1].replace(/,/g,'');
          dispMax = rangeMatch[2].replace(/,/g,'');
        } else {
          const nums = cleaned.match(/\d{1,3}(?:,\d{3})*(?:\.\d+)?/g);
          if (nums && nums.length) { dispMin = nums[0].replace(/,/g,''); if (nums[1]) dispMax = nums[1].replace(/,/g,''); }
        }
      }
    }
    let salaryDisplay = '';
    if (dispMin || dispMax) {
      salaryDisplay = (dispMin ? String(dispMin) : '') + (dispMax ? (' - ' + String(dispMax)) : '');
    } else if (job.salary) {
      salaryDisplay = String(job.salary);
    }

    details.innerHTML = `
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">${job.title || ''}</h5>
          <h6 class="card-subtitle mb-2 text-muted">${job.company || ''} • ${job.location || 'Remote'}</h6>
          <p class="mb-2">${job.description || ''}</p>
          ${typeDisplay ? `<p><strong>Type:</strong> ${typeDisplay}${autoGeneratedType ? ' <span class="badge-auto-generated ms-2" title="This type was auto-selected for display">auto-generated</span>' : ''}</p>` : ''}
          ${salaryDisplay ? `<p><strong>Salary:</strong> ${salaryDisplay}</p>` : ''}
          ${job.skills && job.skills.length ? '<p><strong>Skills:</strong> ' + job.skills.join(', ') + '</p>' : ''}
          ${job.responsibilities ? '<p><strong>Responsibilities:</strong> ' + job.responsibilities + '</p>' : ''}
        </div>
      </div>
    `;
    // auto-fill job title and other details for convenience but keep fields editable
    const jt = document.getElementById('jobTitle');
    if (jt && (!jt.value || jt.value.trim() === '')) jt.value = job.title || '';
    const jc = document.getElementById('jobCompany');
    if (jc) {
      // if company dropdown has the company, select it; otherwise add it as first option
      const companyName = job.company || '';
      let found = Array.from(jc.options).find(o => o.text.trim().toLowerCase() === companyName.trim().toLowerCase());
      if (companyName && !found) {
        const opt = document.createElement('option'); opt.text = companyName; opt.value = companyName; opt.selected = true; jc.insertBefore(opt, jc.options[1]);
      } else if (found) {
        found.selected = true;
      }
    }
    const jl = document.getElementById('jobLocation');
    if (jl && (!jl.value || jl.value.trim() === '')) jl.value = job.location || '';
    const jtType = document.getElementById('jobType');
    const jtOther = document.getElementById('jobTypeOther');
  if (jtType) {
      // Only auto-fill the select if the user hasn't already entered/selected a type
      if (!jtType.value || jtType.value.trim() === '') {
        // try to match preferredType with an existing option
        let matched = null;
        Array.from(jtType.options).forEach(o => {
          if (o.value && o.value.toString().toLowerCase() === preferredType.toLowerCase()) matched = o.value;
        });
        if (matched) {
          jtType.value = matched;
          if (jtOther) jtOther.classList.add('d-none');
          // mark not auto-generated because it matched an explicit option
          autoGeneratedType = false;
        } else if (preferredType) {
          jtType.value = 'Other';
          if (jtOther && (!jtOther.value || jtOther.value.trim() === '')) jtOther.value = preferredType;
          if (jtOther) jtOther.classList.remove('d-none');
          autoGeneratedType = true;
        }
        // store autoGeneratedType on the form so submit handler can access it
        document.getElementById('form').dataset.autoType = autoGeneratedType ? '1' : '0';
      }
    }

    // auto-fill salary min/max if present on job (do not overwrite user input)
    const sMin = document.getElementById('salaryMin');
    const sMax = document.getElementById('salaryMax');
    if (sMin || sMax) {
      // gather possible salary sources
      let min = job.salaryMin || job.minSalary || (job.salary && job.salary.min) || job.min || null;
      let max = job.salaryMax || job.maxSalary || (job.salary && job.salary.max) || job.max || null;
      // if salary is a single number or string like "50000" or "50,000" or a range string, try to parse
      if ((!min && !max) && job.salary) {
        const sal = job.salary;
        if (typeof sal === 'number') {
          min = sal;
        } else if (typeof sal === 'string') {
          // normalize commas
          const cleaned = sal.replace(/\s+/g,'');
          // try dash or to separator
          const rangeMatch = cleaned.match(/(\d{1,3}(?:,\d{3})*(?:\.\d+)?)[-–—to]{1,3}(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/i);
          if (rangeMatch) {
            min = rangeMatch[1].replace(/,/g,'');
            max = rangeMatch[2].replace(/,/g,'');
          } else {
            // pick first number if present
            const nums = cleaned.match(/\d{1,3}(?:,\d{3})*(?:\.\d+)?/g);
            if (nums && nums.length) {
              min = nums[0].replace(/,/g,'');
              if (nums[1]) max = nums[1].replace(/,/g,'');
            }
          }
        }
      }
      // normalize values and ensure both min and max are set when possible
      if (min != null) min = String(min).replace(/,/g,'');
      if (max != null) max = String(max).replace(/,/g,'');
      if ((min || min === 0) && !(max || max === 0)) {
        // if only a single value present, use it for both min and max
        max = min;
      }
      // write back to fields if they are empty
      if (sMin && (!sMin.value || sMin.value.trim() === '')) sMin.value = min != null ? String(min) : '';
      if (sMax && (!sMax.value || sMax.value.trim() === '')) sMax.value = max != null ? String(max) : '';
    }
  }

  // try to fetch single job, fall back to list
  fetch('http://localhost:5000/api/jobs/' + jobId).then(r=>{
    if (r.ok) return r.json();
    return fetch('http://localhost:5000/api/jobs').then(r2=>r2.json());
  }).then(data=>{
    let job = null;
    if (Array.isArray(data)) job = data.find(j=> j._id===jobId || j.id===jobId);
    else job = data;
    renderJob(job);
  }).catch(err=>{
    console.error('Error loading job', err);
  });

  // show/hide Other job type input when user changes select
  const jobTypeSelectElm = document.getElementById('jobType');
  const jobTypeOtherElm = document.getElementById('jobTypeOther');
  if (jobTypeSelectElm && jobTypeOtherElm) {
    jobTypeSelectElm.addEventListener('change', ()=>{
      if (jobTypeSelectElm.value === 'Other') jobTypeOtherElm.classList.remove('d-none');
      else jobTypeOtherElm.classList.add('d-none');
    });
  }

  // ensure form reflects auto-generated flag initially
  const formEl = document.getElementById('form');
  if (!formEl.dataset.autoType) formEl.dataset.autoType = '0';

  // Do not prefill applicant name/email — require user to enter manually

  document.getElementById('form').addEventListener('submit', async e=>{
    e.preventDefault();
    const token = localStorage.getItem('token');
    if (!token) { alert('Please login'); location.href='login.html'; return; }

    const submitBtn = e.submitter || document.querySelector('#form button[type="submit"]');
    if(submitBtn) submitBtn.disabled = true;

  const fd = new FormData();
      fd.append('jobId', jobId);
      fd.append('jobTitle', document.getElementById('jobTitle').value);
      fd.append('company', document.getElementById('jobCompany').value);
      fd.append('location', document.getElementById('jobLocation').value);
  // if user selected Other, prefer the custom text input
  const sel = document.getElementById('jobType');
  const other = document.getElementById('jobTypeOther');
  const typeVal = sel && sel.value === 'Other' ? (other ? other.value : '') : (sel ? sel.value : '');
  // client-side validation: require other text when user selects Other
  if (sel && sel.value === 'Other' && (!other || !other.value || other.value.trim() === '')) {
    document.getElementById('msg').innerHTML = '<div class="alert alert-danger">Please specify the job type when selecting Other.</div>';
    if (submitBtn) submitBtn.disabled = false;
    return;
  }
  fd.append('type', typeVal);
  // append auto-generated flag so backend can persist if desired
  fd.append('autoGeneratedType', (formEl && formEl.dataset.autoType === '1') ? '1' : '0');
      fd.append('salaryMin', document.getElementById('salaryMin').value);
      fd.append('salaryMax', document.getElementById('salaryMax').value);
    fd.append('fullName', document.getElementById('fullName').value);
    fd.append('email', document.getElementById('email').value);
    fd.append('resume', document.getElementById('resume').files[0]);
    try{
      const res = await fetch('http://localhost:5000/api/applications', {
        method:'POST',
        headers: { Authorization: 'Bearer '+token },
        body: fd
      });
      const data = await res.json();
      if (res.ok) {
        document.getElementById('msg').innerHTML = '<div class="alert alert-success">Applied successfully</div>';
        const details = document.getElementById('jobDetails');
        details.insertAdjacentHTML('afterend', `<div class="mt-3"><strong>Your application:</strong><p>${document.getElementById('fullName').value} • ${document.getElementById('email').value}</p></div>`);
      } else {
        document.getElementById('msg').innerHTML = '<div class="alert alert-danger">'+(data.message||'Error')+'</div>';
        if(submitBtn) submitBtn.disabled = false;
      }
    }catch(err){
      console.error(err);
      document.getElementById('msg').innerHTML = '<div class="alert alert-danger">Network error</div>';
      if(submitBtn) submitBtn.disabled = false;
    }
  });
});
</script>
</body>
</html>